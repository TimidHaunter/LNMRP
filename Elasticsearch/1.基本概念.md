# elastic

倒排索引

![image-20220412103422232](C:\Users\1\AppData\Roaming\Typora\typora-user-images\image-20220412103422232.png)

ElasticSearch MySQL

index（索引） Database（数据库）

type（类型） table（数据表）

Doc（文档） Row（数据行）

Mapping（索引定义） Schema（结构定义）

Fields（字段） Column（列）

DSL SQL

## 映射关系 

映射关系不能被删除，要删除索引才行

映射关系能不能修改



mapping

新文档创建自动生成字段类型的映射关系，自动识别

### 字符串 string

text（分词） keyword（不分词）analyzed

### 数值 num

integer byte

### 日期 date

### 布尔 boolean

alias 别名



操作ES有两种方式

## cURL

postman 或者cURL

## REST API - kibana

### 索引

获取所有索引

> GET _cat/indices

``` json
yellow open new-index            S04t8Ei-TOmfLl7MWVbddw 1 1   0 0   283b   283b
yellow open order_log            -TOpStOyTeSTO66dRp12iA 1 1 105 0 29.2kb 29.2kb
green  open .kibana_1            FVIxwe1dTkGqK3DS7kqQkA 1 0   7 1   33kb   33kb
green  open .kibana_task_manager Ip5Tu1IdTDm1_N73XprPCw 1 0   2 0 21.4kb 21.4kb
```



> GET _cat/indices?v

``` json
health status index                uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   new-index            S04t8Ei-TOmfLl7MWVbddw   1   1          0            0       283b           283b
yellow open   order_log            -TOpStOyTeSTO66dRp12iA   1   1        105            0     29.2kb         29.2kb
yellow open   new-index_1          oMPtWX_KQ_yq4o8zoRabtw   1   1          0            0       283b           283b
green  open   .kibana_1            FVIxwe1dTkGqK3DS7kqQkA   1   0          7            1       33kb           33kb
green  open   .kibana_task_manager Ip5Tu1IdTDm1_N73XprPCw   1   0          2            0     21.4kb         21.4kb
```



创建索引

> PUT /new-index_1

```json
{
  "acknowledged" : true,
  "shards_acknowledged" : true,
  "index" : "new-index_1"
}
```



删除索引

> DELETE /new-index

``` json
{
  "acknowledged" : true
}
```



### 文档

在索引中添加文档

>PUT /order_log/_doc/1
>
>{
>	"id": 9999,
>	"uid": 23,
>	"gold": 15,
>	"type": 1,
>	"task_name": "阅读任务",
>	"task_code": "reading",
>	"status": 0,
>	"expire_time": 1651997279,
>	"created_at": "2022-04-08 16:07:59",
>	"updated_at": "2022-04-08 16:07:59"
>}

``` json
{
  "_index" : "order_log",
  "_type" : "_doc",
  "_id" : "2",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 115,
  "_primary_term" : 1
}
```

1是自己传进去的id，如果id已存在，就"result" : "updated"；不存在就"result" : "created"。



在索引中查询文档

> GET /order_log/_doc/XZ7JJoABOT6E_BfAx1As

``` json
{
  "_index" : "order_log",
  "_type" : "_doc",
  "_id" : "XZ7JJoABOT6E_BfAx1As",
  "_version" : 1,
  "_seq_no" : 0,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "id" : 3200,
    "uid" : 23,
    "gold" : 15,
    "type" : 1,
    "task_name" : "阅读任务",
    "task_code" : "reading",
    "status" : 0,
    "expire_time" : 1651997279,
    "created_at" : "2022-04-08 16:07:59",
    "updated_at" : "2022-04-08 16:07:59"
  }
}
```

XZ7JJoABOT6E_BfAx1As 是ES维护的一个id，通过id去查询文档



在索引中删除文档

> DELETE /order_log/_doc/1

``` json
{
  "_index" : "order_log",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 3,
  "result" : "deleted",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 116,
  "_primary_term" : 1
}

# 删除不存在的文档，not_found
{
  "_index" : "order_log",
  "_type" : "_doc",
  "_id" : "2",
  "_version" : 4,
  "result" : "not_found",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 119,
  "_primary_term" : 1
}
```



## 查询

一个标准的查询

``` http
GET /order_log/_doc/_search
{
    "query": {                       #查询体
        "bool": {                    #组合查询
            "must": [{               #满足所有条件
                "match_all": {}
            }],
            "must_not": [],          #不满足所有条件
            "should": []             #满足其中一个条件
        }
    },
    "from": 0,                       #分页，从第几条数据开始
    "size": 10,                      #一页有多少文档
    "sort": [],                      #排序
    "aggs": {}                       #聚合
}
```



### 搜索全部

先看一个简单的查询，match_all

``` http
GET /order_log/_doc/_search
{
	"query": {
		"match_all": {}
	}
}
```



### 分页搜索

``` http
GET /order_log/_doc/_search
{
	"query": {
		"match_all": {}
	},
	"from": 2,
	"size": 5
}
```



### 排序

``` http
GET /order_log/_doc/_search
{
	"query": {
		"match_all": {}
	},
	"sort": {
		"gold": {
			"order": "desc"
		}
	}
}
```



### 返回指定的字段

``` http
GET /order_log/_doc/_search
{
	"query": {
		"match_all": {}
	},
	"_source": ["id", "task_name", "gold"]
}
```



### 条件查询

查找id=3200的文档

``` http
GET /order_log/_doc/_search
{
	"query": {
		"match": {
			"id": 3200
		}
	}
}
```



### 短语匹配搜索

分词后的数据，查询task_name同时包含 “阅读” 和 “ 任” 的文档

``` http
GET /order_log/_doc/_search
{
  "query": {
    "match_phrase": {
      "task_name": "阅读 任"
    }
  }
}
```



### 组合搜索

#### must -> and

使用bool进行组合，must表示同时满足，查询task_name包含 “阅读” 或者 “ 任” 的文档

``` http
GET /order_log/_doc/_search
{
	"query": {
		"bool": {
			"must": [{
					"match": {
						"task_name": "阅读"
					}
				},
				{
					"match": {
						"task_name": "任"
					}
				}
			]
		}
	}
}
```



#### should -> or

满足其中任意一个

``` http
GET /order_log/_doc/_search
{
	"query": {
		"bool": {
			"should": [{
					"match": {
						"task_name": "阅读"
					}
				},
				{
					"match": {
						"task_name": "每日"
					}
				}
			]
		}
	},
	"from": 0,
	"size": 100
}
```



#### must_not

同时不满足，task_name不能包含 “每日” ，uid不能是22

``` http
GET /order_log/_doc/_search
{
	"query": {
		"bool": {
			"must_not": [{
					"match": {
						"task_name": "每日"
					}
				},
				{
					"match": {
						"uid": 22
					}
				}
			]
		}
	}
}
```



组合使用must和must_not

```http
GET /order_log/_doc/_search
{
	"query": {
		"bool": {
			"must": [{
					"match": {
						"task_name": "阅读"
					}
				},
				{
					"match": {
						"task_name": "每日"
					}
				}
			],
			"must_not": [
				{
					"match": {
						"uid": 22
					}
				}
			]
		}
	},
	"from": 0,
	"size": 100
}
```



### 过滤搜索

filter，过滤出gold在200-300之间的文档

``` http
GET /order_log/_doc/_search
{
	"query": {
		"bool": {
			"must": {
				"match_all": {}
			},
			"filter": {
				"range": {
					"gold": {
						"gte": 200,
						"lte": 300
					}
				}
			}
		}
	}
}

```



### 聚合

#### 普通聚合

aggs，类似group by uid，group_by_uid是返回的字段名，可以自定义

``` http
GET /order_log/_doc/_search
{
	"size": 0,
	"aggs": {
		"group_by_uid": {
			"terms": {
				"field": "uid"
			}
		}
	}
}
```



#### 嵌套聚合

``` http
GET /order_log/_doc/_search
{
	"size": 0,
	"aggs": {
		"group_by_uid": {
			"terms": {
				"field": "uid"
			}
		},
		"aggs": {
			"doc_count": {
				"avg": {
					"field": "gold"
				}
			}
		}
	}
}
```



#### 聚合后排序

#### 分段聚合

``` http
GET /order_log/_doc/_search
{
  "size": 0,
  "aggs": {
    "group_by_gold": {
      "range": {
        "field": "gold",
        "ranges": [
          {
            "from": 20,
            "to": 30
          },
          {
            "from": 30,
            "to": 40
          },
          {
            "from": 40,
            "to": 50
          }
        ]
      }
    }
  }
}
```



